# NetFlow to Traces Demo - Full LGTP Stack
# Includes: Loki, Grafana, Tempo, Prometheus, and netflow2traces

x-logging: &logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:
  # Grafana Tempo - Distributed tracing backend
  # Tempo runs as user 10001, and docker compose creates the volume as root.
  # As such, we need to chown the volume in order for Tempo to start correctly.
  init:
    image: busybox:latest
    user: root
    entrypoint:
      - "chown"
      - "10001:10001"
      - "/var/tempo"
    volumes:
      - ./tempo-data:/var/tempo

  memcached:
    image: memcached:1.6.38
    container_name: memcached
    ports:
      - "11211:11211"
    environment:
      - MEMCACHED_MAX_MEMORY=64m # Set the maximum memory usage
      - MEMCACHED_THREADS=4 # Number of threads to use

  tempo:
    image: grafana/tempo:latest
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./tempo.yaml:/etc/tempo.yaml
      - ./tempo-data:/var/tempo
    ports:
      - "14268:14268" # jaeger ingest
      - "3200:3200" # tempo
      - "9095:9095" # tempo grpc
      - "4317:4317" # otlp grpc
      - "4318:4318" # otlp http
      - "9411:9411" # zipkin
    depends_on:
      - init
      - memcached

  # Grafana Loki - Log aggregation system
  loki:
    image: grafana/loki:latest
    container_name: loki
    command: [ "-config.file=/etc/loki/local-config.yaml" ]
    volumes:
      - ./loki/loki-config.yaml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    deploy:
      resources:
        limits:
          memory: 200M
    restart: unless-stopped
    ports:
      - "3100:3100"   # Loki HTTP
    logging: *logging

  prometheus:
    image: prom/prometheus:latest
    command:
      - --config.file=/etc/prometheus.yaml
      - --web.enable-remote-write-receiver
      - --web.enable-otlp-receiver
      - --enable-feature=exemplar-storage
      - --enable-feature=native-histograms
    volumes:
      - ./prometheus.yaml:/etc/prometheus.yaml
    ports:
      - "9090:9090"
  # Grafana - Visualization and observability platform
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/grafana.ini:/etc/grafana/grafana.ini:ro
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    deploy:
      resources:
        limits:
          memory: 300M
    restart: unless-stopped
    ports:
      - "3000:3000"   # Grafana UI
    environment:
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
      - GF_FEATURE_TOGGLES_ENABLE=traceqlEditor metricsSummary

    depends_on:
      loki:
        condition: service_started
      tempo:
        condition: service_started
      prometheus:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging: *logging

  # NetFlow to Traces Converter - Sends telemetry directly to Tempo and Prometheus
  netflow2traces:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: netflow2traces
    environment:
      # NetFlow listener configuration
      - NETFLOW_LISTEN_HOST=0.0.0.0
      - NETFLOW_LISTEN_PORT=2055

      # OpenTelemetry configuration - sends directly to Tempo (traces) and Prometheus (metrics)
      - OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=http://tempo:4317
      - OTEL_EXPORTER_OTLP_TRACES_PROTOCOL=grpc
      - OTEL_EXPORTER_OTLP_METRICS_ENDPOINT=http://prometheus:9090/api/v1/otlp/v1/metrics
      - OTEL_EXPORTER_OTLP_METRICS_PROTOCOL=http
      - OTEL_SERVICE_NAME=netflow-to-traces
      - OTEL_SERVICE_VERSION=0.1.0

      # Logging configuration
      - LOG_LEVEL=INFO
    ports:
      - "2055:2055/udp"  # NetFlow listener port
    depends_on:
      tempo:
        condition: service_started
      prometheus:
        condition: service_started
    restart: unless-stopped
    logging: *logging

  # NetFlow Generator - Continuous traffic generation for demos
  # Sends NetFlow v5 packets with diverse traffic patterns
  # To disable: docker-compose up -d --scale netflow-generator=0
  netflow-generator:
    image: networkstatic/nflow-generator
    container_name: netflow-generator
    command: ["-t", "netflow2traces", "-p", "2055"]
    depends_on:
      netflow2traces:
        condition: service_started
    restart: unless-stopped
    logging: *logging
    
volumes:
  tempo_data:
  grafana_data:
  loki_data:

networks:
  default:
    name: netflow-demo
    driver: bridge

# Usage:
#   docker-compose up -d                              # Start all services (without generator)
#   docker-compose --profile demo up -d               # Start with traffic generator
#   docker-compose logs -f netflow2traces             # View netflow2traces logs
#   docker-compose down                               # Stop all services
#   docker-compose down -v                            # Stop and remove volumes
#
# Access services:
#   Grafana UI:          http://localhost:3000
#   Tempo API:           http://localhost:3200
#   Tempo OTLP gRPC:     localhost:4317
#   Tempo OTLP HTTP:     localhost:4318
#   Loki API:            http://localhost:3100
#   Prometheus UI:       http://localhost:9090
#   Prometheus OTLP:     http://localhost:9090/api/v1/otlp/v1/metrics
#   NetFlow Listener:    localhost:2055 (UDP)
#
# Send test NetFlow data:
#   python ../test_netflow_sender.py --host 127.0.0.1 --port 2055 --count 10
#   python ../tools/netflow_generator.py --version 5 --pattern http --count 10
#   python ../tools/netflow_generator.py --version 9 --pattern mixed --rate 2
